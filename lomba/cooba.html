<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gotong Royong Digital – Marketplace Jasa Warga Desa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --radius: 14px; }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .card { border-radius: var(--radius); }
    .chip { border-radius: 9999px; border: 1px solid rgb(229 231 235); padding: .375rem .75rem; font-size: .875rem; }
    .chip.active { background:#2563eb; color:white; border-color:#2563eb }
    .hidden-vis { display:none; }
    dialog[open] { border:0; border-radius: 16px; width: 100%; max-width: 680px; }
    dialog::backdrop { background: rgba(0,0,0,.4); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-blue-50 to-white text-gray-800">
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-blue-600"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z" stroke="currentColor" stroke-width="1.5"/></svg>
      <h1 class="font-bold text-lg sm:text-xl">Gotong Royong Digital — Marketplace Jasa Warga Desa</h1>
      <div class="ml-auto flex items-center gap-2">
        <button id="roleBtn" class="rounded-xl border px-3 py-2 text-sm bg-white hover:bg-gray-50">Peran: <b id="roleLabel">pengguna</b></button>
        <button id="openAddBtn" class="hidden sm:flex items-center gap-2 rounded-xl bg-blue-600 text-white px-3 py-2 text-sm shadow hover:bg-blue-700">Tawarkan Jasa</button>
        <button id="resetBtn" class="rounded-xl px-3 py-2 text-sm border hover:bg-gray-50" title="Reset Demo">Reset</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <!-- Tabs -->
    <div class="flex gap-2 mb-4 overflow-auto" id="tabs">
      <button data-tab="beranda" class="tab-btn px-4 py-2 rounded-xl border text-sm bg-blue-600 text-white border-blue-600">Beranda</button>
      <button data-tab="favorit" class="tab-btn px-4 py-2 rounded-xl border text-sm bg-white hover:bg-gray-50">Favorit</button>
      <button data-tab="admin" class="tab-btn px-4 py-2 rounded-xl border text-sm bg-white hover:bg-gray-50 hidden" id="adminTab">Admin BUMDes</button>
      <button data-tab="profil" class="tab-btn px-4 py-2 rounded-xl border text-sm bg-white hover:bg-gray-50">Profil</button>
    </div>

    <!-- Beranda -->
    <section id="tab-beranda" class="space-y-4">
      <section class="mb-2">
        <div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-blue-600 to-blue-500 text-white p-6 sm:p-10 shadow">
          <h2 class="text-2xl sm:text-3xl font-bold mb-2">Temukan & Tawarkan Jasa di Desa Anda</h2>
          <p class="max-w-2xl opacity-90">Hubungkan warga yang punya keahlian dengan tetangga yang membutuhkan. Cepat, mudah, dan menguatkan ekonomi lokal.</p>
          <div class="mt-4 flex flex-wrap gap-3">
            <button id="heroAddBtn" class="flex items-center gap-2 rounded-xl bg-white text-blue-700 font-medium px-4 py-2 shadow">Tawarkan Jasa</button>
            <a href="#cari" class="flex items-center gap-2 rounded-xl bg-blue-700 text-white font-medium px-4 py-2 shadow">Cari Jasa</a>
          </div>
        </div>
      </section>

      <div id="cari" class="grid grid-cols-1 sm:grid-cols-12 gap-3">
        <div class="sm:col-span-6 flex items-center gap-2 rounded-xl border p-2 bg-white">
          <input id="qInput" placeholder="Cari: tukang, guru les, jahit…" class="w-full outline-none" />
        </div>
        <div class="sm:col-span-4 flex items-center gap-2 rounded-xl border p-2 bg-white">
          <input id="locInput" placeholder="Lokasi (contoh: Desa Suka Maju)" class="w-full outline-none" />
        </div>
        <div class="sm:col-span-2 flex items-center gap-2 rounded-xl border p-2 bg-white">
          <label for="priceRange" class="text-sm">Harga</label>
          <input id="priceRange" type="range" min="0" max="300000" step="5000" class="w-full" />
          <span id="priceLabel" class="text-sm text-gray-600 whitespace-nowrap">Tanpa batas</span>
        </div>
      </div>

      <div class="mb-1 flex flex-wrap gap-2" id="catRow"></div>
      <div id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <section id="tab-favorit" class="hidden-vis space-y-4">
      <h3 class="font-semibold text-lg">Favorit Saya</h3>
      <div id="favGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="favEmpty" class="text-sm text-gray-500">Belum ada jasa yang ditandai favorit.</div>
    </section>

    <section id="tab-admin" class="hidden-vis space-y-3">
      <h3 class="font-semibold text-lg">Panel Admin BUMDes</h3>
      <div id="pendingGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="pendingEmpty" class="text-sm text-gray-500">Tidak ada pengajuan menunggu.</div>
    </section>

    <section id="tab-profil" class="hidden-vis max-w-xl space-y-4">
      <h3 class="font-semibold text-lg">Profil</h3>
      <div class="grid gap-3">
        <label class="grid gap-1">
          <span class="text-sm font-medium">Nama</span>
          <input id="nameInput" class="border rounded-xl p-3" placeholder="Nama Anda" />
        </label>
        <label class="grid gap-1">
          <span class="text-sm font-medium">Peran</span>
          <select id="roleSelect" class="border rounded-xl p-3">
            <option value="pengguna">Pengguna</option>
            <option value="penyedia">Penyedia Jasa</option>
            <option value="admin">Admin BUMDes</option>
          </select>
        </label>
        <div class="flex justify-end">
          <button id="saveProfileBtn" class="rounded-xl bg-blue-600 text-white px-4 py-2">Simpan</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-[#4B3621] text-white pt-12">
    <div class="max-w-7xl mx-auto px-4 grid md:grid-cols-4 gap-8 pb-12">
      <div>
        <h4 class="text-lg font-semibold mb-2">Dapatkan Info Terbaru</h4>
        <p class="text-sm text-[#f5f1e8] mb-4">Masukkan email Anda untuk mendapatkan informasi dan pembaruan seputar layanan Marketplace Jasa Warga Desa.</p>
        <div class="flex">
          <input type="email" placeholder="Email Anda" class="w-full px-3 py-2 rounded-l-md bg-white text-black text-sm" />
          <button class="bg-[#a3907c] hover:bg-[#84593D] text-white text-sm px-4 py-2 rounded-r-md">Submit</button>
        </div>
      </div>
      <div>
        <h4 class="text-lg font-semibold mb-2">Navigasi</h4>
        <ul class="text-sm space-y-1 text-[#f5f1e8]">
          <li><a href="#hero">Beranda</a></li>
          <li><a href="#cari">Cari Jasa</a></li>
          <li><a href="#tab-favorit">Favorit</a></li>
          <li><a href="#tab-profil">Profil</a></li>
        </ul>
      </div>
      <div>
        <h4 class="text-lg font-semibold mb-2">Kontak</h4>
        <p class="text-sm text-[#f5f1e8]">(+62) 812-3456-7890<br>gotongroyong@desacerdas.id</p>
        <p class="text-sm mt-2 text-[#f5f1e8]">Jl. Raya Desa Cerdas No.1,<br>Indonesia</p>
      </div>
      <div>
        <h4 class="text-lg font-semibold mb-2">Jam Operasional</h4>
        <p class="text-sm text-[#f5f1e8]">Senin – Jumat: 08.00 – 16.00 WIB<br>Sabtu – Minggu: 08.00 – 12.00 WIB</p>
        <a href="https://wa.me/6281234567890" target="_blank" class="inline-block mt-3 bg-[#a3907c] hover:bg-[#84593D] text-white px-4 py-2 rounded-md text-sm">Hubungi via WhatsApp</a>
      </div>
    </div>
    <div class="bg-[#4B3621] py-4 text-center text-xs text-[#ded2c3]">&copy; 2025 Gotong Royong Digital – Marketplace Jasa Warga Desa. All Rights Reserved.</div>
  </footer>

  <template id="cardTpl">
    <div class="card bg-white border shadow-sm overflow-hidden flex flex-col relative">
      <span class="absolute top-3 right-3 text-xs px-2 py-1 rounded-full border bg-blue-50 text-blue-700 cat">Kategori</span>
      <div class="p-4 flex-1 flex flex-col">
        <div class="flex items-start justify-between gap-3">
          <h3 class="font-semibold leading-tight name">Nama</h3>
        </div>
        <div class="mt-1 text-sm text-gray-600 line-clamp-2 desc">Deskripsi</div>
        <div class="mt-2 flex items-center gap-2 text-sm loc">Lokasi</div>
        <div class="mt-2 flex items-center gap-1 text-amber-500 rating"></div>
        <div class="mt-3 font-bold price">Rp0 / sesi</div>
        <div class="mt-3 flex gap-2 mt-auto">
          <a class="flex-1 rounded-xl bg-blue-600 text-white px-3 py-2 text-sm text-center callBtn">Hubungi</a>
          <button class="rounded-xl border px-3 py-2 text-sm reviewBtn">Ulas</button>
          <button class="rounded-xl border px-3 py-2 text-sm favBtn">❤</button>
        </div>
      </div>
    </div>
  </template>


  <script>
    // ---------- State & Utilities ----------
    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
    const storage = {
      get(k, f){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): f }catch{ return f } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) },
      del(k){ localStorage.removeItem(k) }
    };
    const currency = (n) => new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(n||0);

    const categories = [
      { id:'tukang', label:'Tukang' },
      { id:'guru', label:'Guru Les' },
      { id:'jahit', label:'Jahit' },
      { id:'tani', label:'Jasa Tani' },
      { id:'lain', label:'Lainnya' },
    ];

    const sampleServices = [
      { id: crypto.randomUUID(), name:'Pak Budi - Tukang Kayu', category:'tukang', desc:'Spesialis furnitur, rak, dan perbaikan pintu/jendela.', price:150000, location:'Desa Suka Maju', phone:'+6281234567890', rating:4.6, reviews:[], approved:true },
      { id: crypto.randomUUID(), name:'Bu Sari - Guru Les SD', category:'guru', desc:'Matematika & Bahasa Indonesia kelas 1-6. Bisa datang ke rumah.', price:50000, location:'Desa Harapan Jaya', phone:'+6282277788899', rating:4.8, reviews:[], approved:true },
      { id: crypto.randomUUID(), name:'Mbak Wati - Jahit Baju', category:'jahit', desc:'Permak & jahit baru. Selesai cepat, jahitan kuat.', price:35000, location:'Desa Sumber Rejeki', phone:'+6281388882222', rating:4.5, reviews:[], approved:true },
    ];

    const state = {
      services: storage.get('sv_services', sampleServices),
      pending: storage.get('sv_pending', []),
      fav: storage.get('sv_fav', {}),
      user: storage.get('sv_user', { name:'Tamu', role:'pengguna' }),
      filters: { q:'', loc:'', maxPrice:0, cat:'all' },
      activeTab: 'beranda',
    };

    const saveAll = () => {
      storage.set('sv_services', state.services);
      storage.set('sv_pending', state.pending);
      storage.set('sv_fav', state.fav);
      storage.set('sv_user', state.user);
    };

    const avg = (arr) => arr && arr.length ? Math.round((arr.reduce((a,b)=>a+(b.stars||0),0)/arr.length)*10)/10 : 0;

    // ---------- Rendering ----------
    function renderCategories(){
      const row = $('#catRow');
      row.innerHTML = '';
      const makeBtn = (id, label) => {
        const b=document.createElement('button');
        b.className = 'chip ' + (state.filters.cat===id? 'active':'');
        b.textContent = label; b.onclick=()=>{ state.filters.cat=id; renderAll(); };
        return b;
      };
      row.appendChild(makeBtn('all','Semua'));
      categories.forEach(c=> row.appendChild(makeBtn(c.id, c.label)));
    }

    function applyFilters(list){
      let res = list.filter(s=> s.approved);
      const { q, loc, maxPrice, cat } = state.filters;
      if(q) res = res.filter(s=> (s.name+' '+s.desc).toLowerCase().includes(q.toLowerCase()));
      if(cat!=='all') res = res.filter(s=> s.category===cat);
      if(loc) res = res.filter(s=> (s.location||'').toLowerCase().includes(loc.toLowerCase()));
      if(maxPrice>0) res = res.filter(s=> (s.price||0) <= maxPrice);
      return res;
    }

    function ratingStars(r){
      const wrap=document.createElement('div');
      const rounded = Math.round(r||0);
      for(let i=1;i<=5;i++){
        const span = document.createElement('span');
        span.textContent = i<=rounded? '★':'☆';
        span.className = 'text-amber-500';
        wrap.appendChild(span);
      }
      const small = document.createElement('span'); small.className='ml-1 text-xs text-gray-600'; small.textContent = r||0; wrap.appendChild(small);
      return wrap;
    }

    function card(item){
      const tpl = $('#cardTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      $('.name', node).textContent = item.name;
      $('.cat', node).textContent = categories.find(c=>c.id===item.category)?.label || 'Jasa';
      $('.desc', node).textContent = item.desc || '-';
      $('.loc', node).textContent = item.location || '-';
      $('.price', node).textContent = currency(item.price) + ' / sesi';
      const rateWrap = $('.rating', node); rateWrap.appendChild(ratingStars(item.rating));
      const call = $('.callBtn', node);
      call.href = `tel:${item.phone||''}`;
      call.addEventListener('click', e=>{});
      const reviewBtn = $('.reviewBtn', node);
      reviewBtn.onclick = ()=>{
        const stars = Number(prompt('Beri rating 1-5', '5')) || 5;
        const text = prompt('Tulis ulasan (opsional)', '')||'';
        const rv = { id: crypto.randomUUID(), user: state.user.name||'Anon', stars, text };
        item.reviews = [rv, ...(item.reviews||[])];
        item.rating = avg(item.reviews);
        saveAll(); renderAll();
      };
      const favBtn = $('.favBtn', node);
      favBtn.textContent = state.fav[item.id]? '❤':'♡';
      favBtn.onclick = ()=>{ state.fav[item.id] = !state.fav[item.id]; saveAll(); renderAll(); };
      return node;
    }

    function renderGrid(){
      const grid = $('#grid');
      const list = applyFilters(state.services);
      grid.innerHTML = '';
      if(list.length===0){
        grid.innerHTML = '<div class="py-10 text-center text-gray-500 border-2 border-dashed rounded-2xl col-span-full">Tidak ada data yang cocok. Coba periksa kata kunci atau filter.</div>';
        return;
      }
      list.forEach(item=> grid.appendChild(card(item)));
    }

    function renderFav(){
      const favGrid = $('#favGrid');
      const favEmpty = $('#favEmpty');
      favGrid.innerHTML='';
      const list = state.services.filter(s=> state.fav[s.id]);
      favEmpty.classList.toggle('hidden-vis', list.length>0);
      list.forEach(item=> favGrid.appendChild(card(item)));
    }

    function renderAdmin(){
      const grid = $('#pendingGrid');
      const empty = $('#pendingEmpty');
      grid.innerHTML='';
      empty.classList.toggle('hidden-vis', state.pending.length>0);
      state.pending.forEach(p=>{
        const box = document.createElement('div');
        box.className = 'card border bg-white overflow-hidden';
        box.innerHTML = `
          <div class="p-4">
            <div class="font-semibold mb-1">${p.name}</div>
            <div class="text-sm text-gray-600">Kategori: ${categories.find(c=>c.id===p.category)?.label}</div>
            <div class="text-sm text-gray-600">Lokasi: ${p.location||'-'}</div>
            <div class="text-sm text-gray-600">Harga: ${currency(p.price||0)}</div>
            <div class="text-sm mt-2">${p.desc||''}</div>
            <div class="mt-3 flex gap-2">
              <button class="approve rounded-xl bg-emerald-600 text-white px-3 py-2 text-sm">Setujui</button>
              <button class="reject rounded-xl border px-3 py-2 text-sm">Tolak</button>
            </div>
          </div>`;
        $('.approve', box).onclick = ()=>{
          p.approved = true; state.services = [p, ...state.services];
          state.pending = state.pending.filter(x=>x.id!==p.id);
          saveAll(); renderAll(); alert('Disetujui & dipublikasikan');
        };
        $('.reject', box).onclick = ()=>{
          state.pending = state.pending.filter(x=>x.id!==p.id);
          saveAll(); renderAll();
        };
        grid.appendChild(box);
      });
    }

    function renderProfile(){
      $('#nameInput').value = state.user.name||'';
      $('#roleSelect').value = state.user.role||'pengguna';
      $('#roleLabel').textContent = state.user.role||'pengguna';
      // Show admin tab if role admin
      $('#adminTab').classList.toggle('hidden', state.user.role!=='admin');
    }

    function renderTabs(){
      ['beranda','favorit','admin','profil'].forEach(id=>{
        $('#tab-'+id).classList.toggle('hidden-vis', state.activeTab!==id);
      });
      // Keep admin hidden if not admin
      if(state.user.role!=='admin' && state.activeTab==='admin'){
        state.activeTab='beranda';
      }
      $$('.tab-btn').forEach(btn=>{
        const id = btn.dataset.tab; const active = id===state.activeTab;
        btn.className = 'tab-btn px-4 py-2 rounded-xl border text-sm ' + (active? 'bg-blue-600 text-white border-blue-600':'bg-white hover:bg-gray-50');
      });
    }

    function renderAll(){
      renderCategories();
      renderGrid();
      renderFav();
      renderAdmin();
      renderProfile();
      renderTabs();
      saveAll();
    }

    // ---------- Events & Init ----------
    function init(){
      // Year
      $('#year').textContent = new Date().getFullYear();

      // Category dropdown in modal
      const catSel = $('#svcCat');
      categories.forEach(c=>{
        const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.label; catSel.appendChild(opt);
      });

      // Filters
      $('#qInput').addEventListener('input', e=>{ state.filters.q=e.target.value; renderAll(); });
      $('#locInput').addEventListener('input', e=>{ state.filters.loc=e.target.value; renderAll(); });
      const range = $('#priceRange'); const label = $('#priceLabel');
      range.addEventListener('input', e=>{
        const v=Number(e.target.value); state.filters.maxPrice=v; label.textContent = v>0? currency(v): 'Tanpa batas'; renderAll();
      });

      // Tabs
      $$('#tabs .tab-btn').forEach(b=> b.addEventListener('click', ()=>{ state.activeTab=b.dataset.tab; renderAll(); }));

      // Role switch quick button
      $('#roleBtn').addEventListener('click', ()=>{
        const order=['pengguna','penyedia','admin'];
        const idx = order.indexOf(state.user.role); state.user.role = order[(idx+1)%order.length];
        renderAll();
      });

      // Profile save
      $('#saveProfileBtn').addEventListener('click', ()=>{
        state.user.name = $('#nameInput').value || 'Tamu';
        state.user.role = $('#roleSelect').value || 'pengguna';
        alert('Profil disimpan'); renderAll();
      });

      // Reset demo
      $('#resetBtn').addEventListener('click', ()=>{
        if(!confirm('Reset semua data lokal?')) return;
        storage.del('sv_services'); storage.del('sv_pending'); storage.del('sv_fav'); storage.del('sv_user');
        state.services = [...sampleServices]; state.pending=[]; state.fav={}; state.user={ name:'Tamu', role:'pengguna' }; state.filters={ q:'', loc:'', maxPrice:0, cat:'all' };
        $('#qInput').value=''; $('#locInput').value=''; $('#priceRange').value=0; $('#priceLabel').textContent='Tanpa batas';
        renderAll();
      });

      // Add service: open modal buttons
      const openAdd = ()=>{ $('#svcName').value = (state.user.name? state.user.name+' - ':''); $('#addDialog').showModal(); };
      $('#openAddBtn').onclick = openAdd; $('#heroAddBtn').onclick = openAdd;

      // Close modal
      $('#closeAdd').onclick = ()=> $('#addDialog').close();
      $('#cancelAdd').onclick = ()=> $('#addDialog').close();

      // Submit add
      $('#submitAdd').addEventListener('click', (e)=>{
        e.preventDefault();
        const item = {
          id: crypto.randomUUID(),
          name: $('#svcName').value.trim(),
          category: $('#svcCat').value,
          desc: $('#svcDesc').value.trim(),
          price: Number($('#svcPrice').value||0),
          location: $('#svcLoc').value.trim(),
          phone: $('#svcPhone').value.trim(),
          reviews: [], rating: 0, approved: false,
        };
        if(!item.name){ alert('Nama wajib diisi'); return; }
        state.pending = [item, ...state.pending];
        $('#addDialog').close();
        alert('Pengajuan dikirim. Menunggu persetujuan BUMDes.');
        renderAll();
      });

      renderAll();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>